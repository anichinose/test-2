<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英検１級語彙問題</title>
  <style>
    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif; margin:0; padding:0; overflow:hidden;
      display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
      background:url('https://images.unsplash.com/photo-1508264165352-258859e62245?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80') no-repeat center/cover fixed;
      color:#fff;
    }

    .quiz-container{
      width: 100vw;
      height: calc(var(--vh, 1vh) * 100);
      background: rgba(0,0,0,.78);
      padding: clamp(12px, 2.2vw, 20px);
      display:flex; flex-direction:column; box-sizing:border-box; position:relative;
    }

    .header { text-align:center; margin-bottom:8px; }
    .header h1 { margin:0; font-size:24px; color:#facc15; }

    .muted{ color:#cbd5e1; font-size:14px; text-align:center; margin:2px 0 8px; }
    #quiz { flex:1; display:flex; flex-direction:column; gap:10px; }
    .question { font-size:18px; line-height:1.6; font-weight:bold; margin:4px 0 0; white-space:normal; }

    /* Fixed-width gap so the sentence never shifts */
    .gap { display:inline-block; width: 16ch; text-align:center; font-weight:700; }
    .gap.empty { opacity: .35; }

    .sentence-ja { min-height:64px; visibility:hidden; margin:4px 0 8px; color:#e2e8f0; font-size:15px; }

    .choices { list-style:none; padding:0; margin:4px 0 0; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px 14px; }
    .choice-row { display:grid; grid-template-columns:38px 1fr; gap:10px; align-items:center; }

    .icon-btn {
      width:38px; height:38px;
      border-radius:8px;
      border:1px solid #facc15;
      background:#0f172a; color:#e5e7eb;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }
    .icon-btn:hover{ background:#1f2937; }

    .choice-btn {
      width:100%; padding:12px;
      border:1px solid #facc15;
      border-radius:8px;
      background:#1f2937; color:#fff;
      cursor:pointer; font-size:16px; text-align:left; min-height:48px;
    }
    .choice-btn:hover { background:#374151; }

    .correct{ background:#15803d !important; border-color:#22c55e !important; }
    .wrong  { background:#b91c1c !important; border-color:#ef4444 !important; }
    .ja { display:inline-block; margin-left:8px; color:#cbd5e1; font-size:14px; }

    .actions { display:flex; justify-content:center; align-items:center; margin-top:4px; min-height:40px; }
    #next-btn { padding:12px 18px; font-size:16px; border-radius:10px; border:none; background:#3b82f6; color:#fff; cursor:pointer; visibility:hidden; }

    .finish-wrap{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; padding:20px; text-align:center; }
    #final-score{ font-size:20px; font-weight:bold; }
    #final-time{ font-size:16px; color:#facc15; }
    #final-msg{ font-size:16px; color:#e2e8f0; max-width:780px; }
    #yt-btn{ padding:12px 18px; font-size:15px; border-radius:8px; border:none; background:#ff0000; color:#fff; cursor:pointer; display:none; }
    #restart-btn{ padding:12px 18px; font-size:15px; border-radius:8px; border:none; background:#3b82f6; color:#fff; cursor:pointer; display:none; }

    @media (min-width: 1024px){
      .question{ font-size:22px; }
      .sentence-ja{ font-size:18px; min-height:72px; }
      .icon-btn{ width:42px; height:42px; font-size:20px; }
      .choice-btn{ font-size:18px; padding:14px; min-height:54px; }
      #next-btn{ font-size:18px; padding:14px 22px; }
      .gap{ width: 18ch; }
    }
    @media (max-width: 560px){
      .choices{ grid-template-columns: 1fr; }
      .question{ font-size:16px; }
      .gap{ width: 14ch; }
    }
  </style>

  <script>
    // Mobile 100vh fix
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
    setVH();
  </script>
</head>
<body>
  <div class="quiz-container">
    <div class="header"><h1>英検１級語彙問題</h1></div>
    <div class="muted" id="progress">Question 1 of 22</div>
    <div id="quiz"></div>

    <div class="finish-wrap" id="finish" style="display:none">
      <div id="final-score"></div>
      <div id="final-time"></div>
      <div id="final-msg">Thanks for playing, and please subscribe to my YouTube channel for future updates!</div>
      <a href="https://www.youtube.com/@eigophile" target="_blank"><button id="yt-btn">My YouTube Channel</button></a>
      <button id="restart-btn">Play Again</button>
    </div>
  </div>

  <script>
    // ===== Data =====
    const BLANK_HTML = '(<span class="gap empty" aria-live="polite">&nbsp;</span>)';
    const questions = [
      // (same 22-question array from previous message…)
      // For brevity here, assume all 22 objects are included
      // ...
    ];

    // ===== State & DOM =====
    let currentQuestion=0, score=0, startTime=0;
    const quizContainer=document.getElementById('quiz');
    const progress=document.getElementById('progress');
    const finish=document.getElementById('finish');
    const finalScore=document.getElementById('final-score');
    const finalTime=document.getElementById('final-time');
    const restartBtn=document.getElementById('restart-btn');
    const ytBtn=document.getElementById('yt-btn');

    // Build Next button once, re-use
    const nextBtn=document.createElement('button');
    nextBtn.id='next-btn';
    nextBtn.textContent='Next';

    // ===== Audio (correct / wrong) =====
    let audioCtx;
    function getCtx(){ return audioCtx || (audioCtx = new (window.AudioContext || window.webkitAudioContext)()); }
    function beep(freq,duration=0.14,gain=0.08,type='sine'){
      const ctx=getCtx(); const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=0.0001; g.connect(ctx.destination); o.connect(g);
      o.start();
      g.gain.exponentialRampToValueAtTime(gain, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+duration);
      o.stop(ctx.currentTime+duration+0.02);
    }
    function playCorrect(){ beep(523.25,0.12); setTimeout(()=>beep(659.25,0.12),110); setTimeout(()=>beep(783.99,0.18),220); }
    function playWrong(){
      const ctx=getCtx(); const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(240,ctx.currentTime);
      o.frequency.linearRampToValueAtTime(170,ctx.currentTime+0.28);
      g.gain.setValueAtTime(0.15,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.3);
      o.connect(g); g.connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime+0.34);
    }

    // ===== TTS Pronunciation =====
    function speak(text){
      if(!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      const v=window.speechSynthesis.getVoices();
      const en=v.find(x=>/^en(-|_|$)/i.test(x.lang))||v[0];
      if(en) u.voice=en; u.rate=0.95; u.pitch=1;
      window.speechSynthesis.speak(u);
    }
    if ('speechSynthesis' in window) { window.speechSynthesis.getVoices(); }

    // ===== Utils =====
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
    function formatTime(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }

    // ===== Render =====
    function render(){
      if(currentQuestion===0 && !startTime){ startTime = Date.now(); }
      const q=questions[currentQuestion];
      progress.textContent=`Question ${currentQuestion+1} of ${questions.length}`;

      // Reset inner quiz
      quizContainer.innerHTML=`<div class='question'>${q.q}</div><div class='sentence-ja' id='ja-slot'></div>`;

      const choices=q.a.map((text,idx)=>({text,ja:q.jaChoices[idx],ok:idx===q.correct}));
      shuffle(choices);
      const ul=document.createElement('ul'); ul.className='choices';
      choices.forEach((c,i)=>{
        const li=document.createElement('li');
        const row=document.createElement('div'); row.className='choice-row';
        const icon=document.createElement('button'); icon.className='icon-btn'; icon.type='button'; icon.innerHTML='&#128264;';
        icon.addEventListener('click', ev => { ev.stopPropagation(); speak(c.text); });
        const btn=document.createElement('button'); btn.className='choice-btn'; btn.type='button'; btn.textContent=`${i+1}. ${c.text}`;
        btn.onclick=()=>select(btn,c.ok,choices);
        row.appendChild(icon); row.appendChild(btn); li.appendChild(row); ul.appendChild(li);
      });
      quizContainer.appendChild(ul);

      // Append Next button right under choices
      const actions=document.createElement('div');
      actions.className='actions';
      actions.appendChild(nextBtn);
      quizContainer.appendChild(actions);

      nextBtn.style.visibility='hidden';
      finish.style.display='none'; restartBtn.style.display='none'; ytBtn.style.display='none';
    }

    function select(btn,ok,choices){
      const buttons = document.querySelectorAll('.choice-btn');
      buttons.forEach(b=>b.disabled=true);
      if(ok){btn.classList.add('correct'); score++; playCorrect();}
      else {btn.classList.add('wrong'); const right=[...buttons].find((b,i)=>choices[i].ok); if(right) right.classList.add('correct'); playWrong();}

      const correct = choices.find(c=>c.ok)?.text || '';
      const gapEl = document.querySelector('.question .gap');
      if(gapEl){ gapEl.textContent = correct; gapEl.classList.remove('empty'); }

      buttons.forEach((b,i)=>{
        if(!b.querySelector('.ja')){ const s=document.createElement('span'); s.className='ja'; s.textContent = ` ${choices[i].ja}`; b.appendChild(s); }
      });

      const slot=document.getElementById('ja-slot');
      slot.style.visibility='visible';
      slot.textContent=questions[currentQuestion].jaSentence;

      nextBtn.style.visibility='visible';
    }

    nextBtn.addEventListener('click',()=>{
      currentQuestion++;
      if(currentQuestion<questions.length){
        render();
      } else {
        quizContainer.innerHTML='';
        progress.textContent='Finished';
        finalScore.textContent=`You scored ${score} out of ${questions.length}!`;
        finalTime.textContent=`Time: ${formatTime(Date.now()-startTime)}`;
        finish.style.display='flex';
        ytBtn.style.display='inline-block';
        restartBtn.style.display='inline-block';
        nextBtn.style.visibility='hidden';
      }
    });

    restartBtn.addEventListener('click',()=>{
      currentQuestion=0; score=0; startTime=0;
      finish.style.display='none';
      render();
    });

    render();
  </script>
</body>
</html>
