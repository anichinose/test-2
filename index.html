<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±æ¤œï¼‘ç´šèªå½™å•é¡Œ â€” 10ã‚»ãƒƒãƒˆï¼‹å¾©ç¿’</title>
  <style>
    :root{
      --accent-green: #14532d;  /* dark green for title/borders */
      --accent-gold:  #d4af37;  /* thin gold for buttons */
      --tile-h: 90px;          /* uniform tile height on home */
    }

    html, body { height: 100%; }
    body {
      font-family: Arial, sans-serif; margin:0; padding:0; overflow:hidden;
      display:flex; justify-content:center; align-items:flex-start; min-height:100vh;
      background:url('https://images.unsplash.com/photo-1508264165352-258859e62245?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80') no-repeat center/cover fixed;
      color:#fff;
      -webkit-text-size-adjust: 100%; /* iOS Safari: prevent unexpected zoomed text */
    }

    .quiz-shell{
      width: 100vw; height: calc(var(--vh, 1vh) * 100);
      background: rgba(0,0,0,.78);
      padding: clamp(12px, 2.2vw, 20px);
      display:flex; flex-direction:column; box-sizing:border-box; position:relative;
    }

    .header { text-align:center; margin-bottom:8px; }
    .header h1{
      margin:0;
      /* Fluid title sizing for phones â†’ desktops */
      font-size: clamp(16px, 5.2vw, 26px);
      color:#fff; background:var(--accent-green);
      display:inline-block; padding: clamp(4px, 1vw, 6px) clamp(10px, 2.2vw, 14px);
      border-radius:12px; line-height:1.15; letter-spacing:.02em;
    }
    .muted{ color:#cbd5e1; font-size:14px; text-align:center; margin:2px 0 8px; }

    /* ===== Home ===== */
    #home-view{ display:flex; flex-direction:column; height:100%; }
    .home-grid{
      display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:8px; margin-top:4px;
      grid-auto-rows: var(--tile-h);   /* uniform row height */
      transform-origin: top center;
    }
    @media (min-width: 1200px){ .home-grid{ grid-template-columns: repeat(5, minmax(0,1fr)); } }
    @media (min-width: 1440px){ .home-grid{ grid-template-columns: repeat(6, minmax(0,1fr)); } }

    .tile{
      height: var(--tile-h);
      padding:12px; border-radius:12px; border:2px solid var(--accent-green);
      background:#1f2937; color:#fff; cursor:pointer; text-align:center;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
      font-size: clamp(14px, 4vw, 18px); font-weight:700; letter-spacing:.2px; box-sizing:border-box;
      overflow:hidden; /* prevent tiny spillovers on small iPhones */
    }
    .tile:hover{ background:#374151; }
    .tile .title{ display:flex; align-items:center; justify-content:center; gap:8px; line-height:1; white-space:normal; flex-wrap:wrap; }
    .tile .sub{ display:block; font-size:11px; color:#cbd5e1; font-weight:400; letter-spacing:0; line-height:1.1; }
    .tile.review{ border-color: var(--accent-gold); }
    .tile[disabled]{ opacity:.45; cursor:not-allowed; }
    .badge{ display:inline-block; min-width:20px; padding:2px 6px; border-radius:999px; background:var(--accent-gold); color:#000; font-size:12px; font-weight:700; line-height:1; }

    /* ===== Play view ===== */
    #play-view{ display:none; flex-direction:column; height:100%; gap:6px; }

    .topline{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:8px; }
    .navbtns{ display:flex; gap:8px; align-items:center; justify-content:flex-start; }
    .topline .header{ margin:0; }
    .topline .muted{ margin:0; text-align:right; }

    #quiz { flex:1; display:flex; flex-direction:column; gap:10px; }
    .question { font-size:18px; line-height:1.6; font-weight:bold; margin:4px 0 0; white-space:normal; }
    .qnum{ margin-right:8px; color:#e2e8f0; }
    .gap { display:inline-block; width: 16ch; text-align:center; font-weight:700; }
    .gap.empty { opacity: .35; }
    .sentence-ja { min-height:64px; visibility:hidden; margin:4px 0 8px; color:#e2e8f0; font-size:15px; }

    .choices { list-style:none; padding:0; margin:4px 0 0; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px 14px; }
    .choice-row { display:grid; grid-template-columns:38px 1fr; gap:10px; align-items:center; }

    .icon-btn { width:38px; height:38px; border-radius:8px; border:2px solid var(--accent-green); background:#0f172a; color:#e5e7eb; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; }
    .icon-btn:hover{ background:#1f2937; }

    .choice-btn { width:100%; padding:12px; border:2px solid var(--accent-green); border-radius:8px; background:#1f2937; color:#fff; cursor:pointer; font-size:16px; text-align:left; min-height:48px; }
    .choice-btn:hover { background:#374151; }

    .correct{ background:#15803d !important; border-color:#22c55e !important; }
    .wrong  { background:#b91c1c !important; border-color:#ef4444 !important; }
    .ja { display:inline-block; margin-left:8px; color:#cbd5e1; font-size:14px; }

    .actions { display:flex; justify-content:center; align-items:center; margin-top:4px; min-height:40px; }
    .btn{ padding:12px 18px; font-size:16px; border-radius:10px; background:#000; color: var(--accent-gold); border:1px solid var(--accent-gold); cursor:pointer; font-weight:400; letter-spacing:.2px; }
    .btn.sm{ padding:8px 12px; font-size:14px; border-radius:8px; }
    #next-btn{ visibility:hidden; }
    .btn:hover{ background:#0a0a0a; }
    .btn:focus-visible{ outline:2px solid var(--accent-gold); outline-offset:2px; }

    .finish-wrap{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; padding:20px; text-align:center; }
    #final-score{ font-size:20px; font-weight:bold; }
    #final-time{ font-size:16px; color:#facc15; }
    #final-msg{ font-size:16px; color:#e2e8f0; max-width:780px; }
    #yt-btn{ padding:12px 18px; font-size:15px; border-radius:8px; border:none; background:#ff0000; color:#fff; cursor:pointer; display:none; }
    #restart-btn{ display:none; }
    #home-btn{ display:none; }

    @media (min-width: 1024px){
      /* clamp() already covers large screens; keep other element bumps */
      .question{ font-size:22px; }
      .sentence-ja{ font-size:18px; min-height:72px; }
      .icon-btn{ width:42px; height:42px; font-size:20px; }
      .choice-btn{ font-size:18px; padding:14px; min-height:54px; }
      .gap{ width: 18ch; }
    }
    @media (max-width: 560px){
      .choices{ grid-template-columns: 1fr; }
      .question{ font-size:16px; }
      .gap{ width: 14ch; }
    }
    /* Smaller badge & tighter tiles on very narrow phones */
    @media (max-width: 420px){ .badge{ font-size:11px; min-width:18px; padding:1px 6px; } }
    @media (max-width: 380px){ :root{ --tile-h: 80px; } }
  </style>

  <script>
    // Mobile 100vh fix
    function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
    setVH();
  </script>
</head>
<body>
  <div class="quiz-shell">

    <!-- ===== HOME ===== -->
    <div id="home-view">
      <div class="header"><h1>è‹±æ¤œï¼‘ç´šèªå½™å•é¡Œ</h1></div>
      <div class="muted">10ã‚»ãƒƒãƒˆï¼ˆå„22å•ï¼‰ï¼‹é–“é•ã„ç›´ã—ç”¨ã®å¾©ç¿’</div>
      <div class="home-grid" id="home-grid"></div>
    </div>

    <!-- ===== PLAY ===== -->
    <div id="play-view">
      <div class="topline">
        <div class="navbtns">
          <button id="home-top" type="button" class="btn sm">Home</button>
          <button id="back-top" type="button" class="btn sm">Back</button>
        </div>
        <div class="header"><h1 id="set-title">è‹±æ¤œï¼‘ç´šèªå½™å•é¡Œ</h1></div>
        <div class="muted" id="progress">Question 1 of 22</div>
      </div>

      <div id="quiz"></div>

      <div class="finish-wrap" id="finish" style="display:none">
        <div id="final-score"></div>
        <div id="final-time"></div>
        <div id="final-msg">Thanks for playing, and please subscribe to my YouTube channel for future updates!</div>
        <a href="https://www.youtube.com/@eigophile" target="_blank"><button id="yt-btn" type="button">My YouTube Channel</button></a>
        <div style="display:flex; gap:10px;">
          <button id="restart-btn" type="button" class="btn">Play Again</button>
          <button id="home-btn" type="button" class="btn">Home</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Data (base 22 questions) =====
    const BLANK_HTML = '(<span class="gap empty" aria-live="polite">&nbsp;</span>)';
    const BASE_QUESTIONS = [
      {q:`Despite the heated debate, the chair maintained perfect ${BLANK_HTML}, speaking calmly and treating both sides fairly.`, a:["equanimity","bravado","parsimony","pomposity"], correct:0, jaChoices:["å¹³é™ã•ï¼ˆå†·é™æ²ˆç€ï¼‰","è™šå‹¢","å€¹ç´„","å°Šå¤§ã•"], jaSentence:"ç™½ç†±ã—ãŸè¨è«–ã®ä¸­ã§ã‚‚ã€è­°é•·ã¯çµ‚å§‹å¹³é™ã•ã‚’ä¿ã¡ã€è½ã¡ç€ã„ã¦ä¸¡è€…ã‚’å…¬å¹³ã«æ‰±ã£ãŸã€‚"},
      {q:`The committee favored a ${BLANK_HTML} approachâ€”small, testable steps instead of a sweeping overhaul.`, a:["pragmatic","ornate","capricious","derivative"], correct:0, jaChoices:["å®Ÿå‹™çš„ãªï¼ˆå®Ÿç”¨ä¸»ç¾©çš„ãªï¼‰","è£…é£¾çš„ãª","æ°—ã¾ãã‚Œãª","æ¨¡å€£çš„ãª"], jaSentence:"å§”å“¡ä¼šã¯å¤§è¦æ¨¡ãªå…¨é¢æ”¹é©ã§ã¯ãªãã€å°ã•ãæ¤œè¨¼å¯èƒ½ãªæ®µéšã‚’è¸ã‚€å®Ÿå‹™çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ”¯æŒã—ãŸã€‚"},
      {q:`The CEO issued a rare statement of ${BLANK_HTML}, admitting the rollout had been mishandled.`, a:["contrition","discretion","tenacity","levity"], correct:0, jaChoices:["æ‚”æ¨ï¼ˆåçœï¼‰","æ…é‡ã•","ç²˜ã‚Šå¼·ã•","è»½ç‡ã•"], jaSentence:"CEOã¯ã€å°å…¥ãŒä¸æ‰‹éš›ã ã£ãŸã¨èªã‚ã‚‹ç•°ä¾‹ã®åçœå£°æ˜ã‚’ç™ºè¡¨ã—ãŸã€‚"},
      {q:`Her explanation sounded convincing at first, but on closer inspection it rested on a ${BLANK_HTML} link between cause and effect.`, a:["tenuous","trenchant","effulgent","docile"], correct:0, jaChoices:["å¸Œè–„ãªï¼ˆè„†å¼±ãªï¼‰","ç—›çƒˆãª","å…‰ã‚Šè¼ã","å¾“é †ãª"], jaSentence:"å½¼å¥³ã®èª¬æ˜ã¯ä¸€è¦‹ã‚‚ã£ã¨ã‚‚ã‚‰ã—ã‹ã£ãŸãŒã€ã‚ˆãèª¿ã¹ã‚‹ã¨å› æœé–¢ä¿‚ãŒå¸Œè–„ãªå‰æã«ç«‹è„šã—ã¦ã„ãŸã€‚"},
      {q:`Public outrage ${BLANK_HTML} lawmakers into drafting stronger consumer-protection rules within days.`, a:["galvanized","usurped","immolated","capsized"], correct:0, jaChoices:["çªãå‹•ã‹ã—ãŸï¼ˆåˆºæ¿€ã—ãŸï¼‰","ç°’å¥ªã—ãŸ","ç„¼èº«ã—ãŸ","è»¢è¦†ã•ã›ãŸ"], jaSentence:"ä¸–è«–ã®æ€’ã‚ŠãŒè­°å“¡ãŸã¡ã‚’çªãå‹•ã‹ã—ã€æ•°æ—¥ã®ã†ã¡ã«ã‚ˆã‚Šå¼·åŠ›ãªæ¶ˆè²»è€…ä¿è­·è¦å‰‡ã®è‰æ¡ˆä½œæˆã¸ã¨é§†ã‚Šç«‹ã¦ãŸã€‚"},
      {q:`After reviewing new evidence, the university ${BLANK_HTML} its earlier decision and reinstated the student.`, a:["rescinded","ratified","subsidized","conflated"], correct:0, jaChoices:["æ’¤å›ã—ãŸ","æ‰¿èªã—ãŸ","åŠ©æˆã—ãŸ","æ··åŒã—ãŸ"], jaSentence:"æ–°è¨¼æ‹ ã®æ¤œè¨å¾Œã€å¤§å­¦ã¯ä»¥å‰ã®æ±ºå®šã‚’æ’¤å›ã—ã€ãã®å­¦ç”Ÿã‚’å¾©å­¦ã•ã›ãŸã€‚"},
      {q:`Cutting the budget now would only ${BLANK_HTML} the problem by delaying essential maintenance.`, a:["exacerbate","ameliorate","quantify","emulate"], correct:0, jaChoices:["æ‚ªåŒ–ã•ã›ã‚‹","æ”¹å–„ã™ã‚‹","æ•°é‡åŒ–ã™ã‚‹","è¦‹ç¿’ã†"], jaSentence:"ä»Šäºˆç®—ã‚’å‰Šæ¸›ã™ã‚‹ã¨ã€å¿…è¦ãªä¿å®ˆã‚’å…ˆå»¶ã°ã—ã«ã™ã‚‹ã“ã¨ã§å•é¡Œã‚’æ‚ªåŒ–ã•ã›ã‚‹ã ã‘ã ã€‚"},
      {q:`The files were stored in a ${BLANK_HTML} server accessible only to a handful of trusted engineers.`, a:["clandestine","ramshackle","plenary","callous"], correct:0, jaChoices:["ç§˜å¯†ã®ï¼ˆéå…¬é–‹ã®ï¼‰","ãŒãŸãŒãŸã®","å…¨ä½“å‡ºå¸­ã®","å†·æ·¡ãª"], jaSentence:"ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã”ãå°‘æ•°ã®ä¿¡é ¼ã§ãã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã ã‘ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ç§˜å¯†ã®ã‚µãƒ¼ãƒãƒ¼ã«ä¿ç®¡ã•ã‚Œã¦ã„ãŸã€‚"},
      {q:`His apology was so ${BLANK_HTML} that the audience felt he was merely going through the motions.`, a:["perfunctory","rhapsodic","didactic","verdant"], correct:0, jaChoices:["ãŠã–ãªã‚Šã®ï¼ˆå½¢ã ã‘ã®ï¼‰","ç†±ç‹‚çš„ãª","æ•™è¨“çš„ãª","é’ã€…ã¨ã—ãŸ"], jaSentence:"å½¼ã®è¬ç½ªã¯ã‚ã¾ã‚Šã«å½¢ã ã‘ã ã£ãŸã®ã§ã€è´è¡†ã¯å˜ã«å„€ç¤¼çš„ã«æ¸ˆã¾ã›ã¦ã„ã‚‹ã¨æ„Ÿã˜ãŸã€‚"},
      {q:`Negotiators adopted a less ${BLANK_HTML} tone, opening the door to a face-saving compromise.`, a:["belligerent","libertine","diffident","obtuse"], correct:0, jaChoices:["å¥½æˆ¦çš„ãª","æ”¾è•©ã®","é æ…®ãŒã¡ãª","éˆæ„Ÿãª"], jaSentence:"äº¤æ¸‰æ‹…å½“è€…ã¯ã‚ˆã‚Šéå¥½æˆ¦çš„ãªå£èª¿ã«åˆ‡ã‚Šæ›¿ãˆã€é¢å­ã‚’ä¿ã¦ã‚‹å¦¥å”ã®ä½™åœ°ãŒç”Ÿã¾ã‚ŒãŸã€‚"},
      {q:`Charities stepped in to support families left ${BLANK_HTML} after the factory closure.`, a:["destitute","florid","punctilious","sprightly"], correct:0, jaChoices:["æ¥µè²§ã®","è¯ç¾ãª","å‡ å¸³é¢ãª","æ´»ç™ºãª"], jaSentence:"å·¥å ´é–‰é–ã§æ¥µè²§ã«é™¥ã£ãŸå®¶æ—ã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã€æ…ˆå–„å›£ä½“ãŒä»‹å…¥ã—ãŸã€‚"},
      {q:`To ${BLANK_HTML} the impact of the outage, the company offered free upgrades and extended support hours.`, a:["mitigate","instigate","obfuscate","divest"], correct:0, jaChoices:["ç·©å’Œã™ã‚‹","æ‰‡å‹•ã™ã‚‹","æ›–æ˜§ã«ã™ã‚‹","å£²å´ã™ã‚‹"], jaSentence:"éšœå®³ã®å½±éŸ¿ã‚’ç·©å’Œã™ã‚‹ãŸã‚ã€åŒç¤¾ã¯ç„¡å„Ÿã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¨ã‚µãƒãƒ¼ãƒˆæ™‚é–“ã®å»¶é•·ã‚’æä¾›ã—ãŸã€‚"},
      {q:`The exhibit ${BLANK_HTML} medieval maps with satellite imagery to highlight how perceptions of space have changed.`, a:["juxtaposed","corrugated","extirpated","consecrated"], correct:0, jaChoices:["ä¸¦ç½®ã—ãŸï¼ˆå¯¾æ¯”ã•ã›ãŸï¼‰","æ³¢çŠ¶ã®","æ ¹çµ¶ã—ãŸ","è–åˆ¥ã—ãŸ"], jaSentence:"å±•ç¤ºã¯ä¸­ä¸–ã®åœ°å›³ã¨è¡›æ˜Ÿç”»åƒã‚’ä¸¦ç½®ã—ã€ç©ºé–“èªè­˜ã®å¤‰åŒ–ã‚’æµ®ãå½«ã‚Šã«ã—ãŸã€‚"},
      {q:`Her notes were so ${BLANK_HTML} that even months later she could reconstruct every step of the experiment.`, a:["meticulous","profligate","mercurial","jejune"], correct:0, jaChoices:["ç¶¿å¯†ãª","æµªè²»çš„ãª","æ°—ã¾ãã‚Œãª","æœªç†Ÿãªï¼å‘³æ°—ãªã„"], jaSentence:"å½¼å¥³ã®ãƒãƒ¼ãƒˆã¯éå¸¸ã«ç¶¿å¯†ã§ã€æ•°ã‹æœˆå¾Œã§ã‚‚å®Ÿé¨“ã®å…¨å·¥ç¨‹ã‚’å†ç¾ã§ããŸã€‚"},
      {q:`They conducted a ${BLANK_HTML} review of the contract, making discrete edits without alerting competitors.`, a:["surreptitious","sybaritic","bucolic","hedonic"], correct:0, jaChoices:["å†…å¯†ã®ï¼ˆã“ã£ãã‚Šã—ãŸï¼‰","äº«æ¥½çš„ãª","ç”°åœ’ã®","å¿«æ¥½ä¸»ç¾©ã®"], jaSentence:"å½¼ã‚‰ã¯ç«¶åˆã«æ°—ã¥ã‹ã‚Œãªã„ã‚ˆã†ã€å¥‘ç´„æ›¸ã‚’å†…å¯†ã«è¦‹ç›´ã—ã¦ç‚¹åœ¨ã™ã‚‹ä¿®æ­£ã‚’åŠ ãˆãŸã€‚"},
      {q:`Expanding too quickly can have unintended ${BLANK_HTML}, such as quality drift and supply bottlenecks.`, a:["ramifications","panaceas","euphemisms","confections"], correct:0, jaChoices:["ï¼ˆå¥½ã¾ã—ããªã„ï¼‰çµæœãƒ»æ³¢åŠåŠ¹æœ","ä¸‡èƒ½è–¬","å©‰æ›²èª","è“å­ï¼ˆå‰µä½œç‰©ï¼‰"], jaSentence:"æ‹¡å¤§ã‚’æ€¥ãã™ãã‚‹ã¨ã€å“è³ªã®é€¸è„±ã‚„ä¾›çµ¦ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãªã©æœ›ã¾ã—ããªã„æ³¢åŠåŠ¹æœãŒç”Ÿã˜å¾—ã‚‹ã€‚"},
      {q:`Even after the milestone, her curiosity was ${BLANK_HTML}; she kept probing for a better solution.`, a:["insatiable","amenable","venerable","tractable"], correct:0, jaChoices:["é£½ãã“ã¨ã®ãªã„","å¾“é †ãªï¼å—ã‘å…¥ã‚Œã‚„ã™ã„","å°Šæ•¬ã™ã¹ã","æ‰±ã„ã‚„ã™ã„"], jaSentence:"ç¯€ç›®ã‚’è¿ãˆãŸå¾Œã‚‚å½¼å¥³ã®å¥½å¥‡å¿ƒã¯é£½ãã“ã¨ãªãã€ã‚ˆã‚Šè‰¯ã„è§£æ±ºç­–ã‚’æ¢ã‚Šç¶šã‘ãŸã€‚"},
      {q:`The study was initially ${BLANK_HTML} by peers, but later replication cemented its reputation.`, a:["disparaged","lionized","canonized","apotheosized"], correct:0, jaChoices:["ã‘ãªã•ã‚ŒãŸ","ç§°è³›ã•ã‚ŒãŸ","æ­£å…¸åŒ–ã•ã‚ŒãŸ","ç¥æ ¼åŒ–ã•ã‚ŒãŸ"], jaSentence:"å½“åˆãã®ç ”ç©¶ã¯åŒåƒšã«ã‘ãªã•ã‚ŒãŸãŒã€å¾Œã®è¿½è©¦ã§è©•ä¾¡ãŒç¢ºå›ºãŸã‚‹ã‚‚ã®ã«ãªã£ãŸã€‚"},
      {q:`A: Why is everyone stuck on this puzzle?<br>B: Because itâ€™s a genuine ${BLANK_HTML}â€”the data point in two directions at once.`, a:["conundrum","reprieve","catalyst","preamble"], correct:0, jaChoices:["é›£å•ï¼ˆè¬ï¼‰","çŒ¶äºˆ","è§¦åª’","å‰ç½®ã"], jaSentence:"A: ã¿ã‚“ãªãªãœã“ã®ãƒ‘ã‚ºãƒ«ã§è¡Œãè©°ã¾ã£ã¦ã‚‹ã®ï¼Ÿ B: æœ¬ç‰©ã®é›£å•ãªã‚“ã ã€‚ãƒ‡ãƒ¼ã‚¿ãŒåŒæ™‚ã«äºŒã¤ã®æ–¹å‘ã‚’ç¤ºã—ã¦ã„ã‚‹ã‹ã‚‰ã€‚"},
      {q:`After a long hiatus, she ${BLANK_HTML} on her coding skills and shipped a polished app in two weeks.`, a:["brushed up","dwelled on","petered out","skewed off"], correct:0, jaChoices:["ï¼ˆæŠ€èƒ½ã‚’ï¼‰ç£¨ãç›´ã—ãŸ","ã“ã ã‚ã‚Šç¶šã‘ãŸ","æ¬¡ç¬¬ã«æ¶ˆãˆãŸ","ï¼ˆèª¤ã£ã¦ï¼‰é€¸ã‚ŒãŸ"], jaSentence:"é•·ã„ãƒ–ãƒ©ãƒ³ã‚¯ã®å¾Œã€å½¼å¥³ã¯ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®è…•ã‚’ç£¨ãç›´ã—ã€2é€±é–“ã§å®Œæˆåº¦ã®é«˜ã„ã‚¢ãƒ—ãƒªã‚’å‡ºè·ã—ãŸã€‚"},
      {q:`When the project scope ballooned, the team ${BLANK_HTML} and set stricter boundaries.`, a:["drew the line","played it by ear","let it slide","split hairs"], correct:0, jaChoices:["ä¸€ç·šã‚’å¼•ã„ãŸï¼ˆç·šå¼•ãã—ãŸï¼‰","è‡¨æ©Ÿå¿œå¤‰ã«ã‚„ã£ãŸ","å¤§ç›®ã«è¦‹ãŸ","é‡ç®±ã®éš…ã‚’ã¤ã¤ã„ãŸ"], jaSentence:"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç¯„å›²ãŒè†¨å¼µã—ãŸã¨ãã€ãƒãƒ¼ãƒ ã¯ä¸€ç·šã‚’å¼•ã„ã¦ã‚ˆã‚Šå³æ ¼ãªå¢ƒç•Œã‚’è¨­å®šã—ãŸã€‚"},
      {q:`Tourists who ignore local advisories often get ${BLANK_HTML} with hefty fines for driving into restricted zones.`, a:["slapped","stumped","coddled","beguiled"], correct:0, jaChoices:["ç§‘ã•ã‚Œã‚‹ï¼ˆä¸æ„ã«ä¸ãˆã‚‰ã‚Œã‚‹ï¼‰","å›°ã‚‰ã›ã‚‰ã‚Œã‚‹","ç”˜ã‚„ã‹ã•ã‚Œã‚‹","ã ã¾ã•ã‚Œã‚‹"], jaSentence:"ç¾åœ°ã®æ³¨æ„å–šèµ·ã‚’ç„¡è¦–ã™ã‚‹è¦³å…‰å®¢ã¯ã€é€²å…¥ç¦æ­¢åŒºåŸŸã«å…¥ã£ã¦é«˜é¡ãªç½°é‡‘ã‚’ç§‘ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã€‚"}
    ].map((q,idx)=>({ id: idx, ...q }));

    // ===== State & DOM =====
    let currentQuestion=0, score=0, startTime=0;
    let activeQuestions = [];
    let mode = 'home'; // 'set' | 'review'
    let currentSet = null; // 1..10 or 'review'

    // per-question UI state
    let choiceOrder = [];     // array of arrays (length 4) with indices 0..3 in display order
    let answers = [];         // boolean | null per question
    let selectedIdx = [];     // chosen index in display order (0..3) or null

    const homeView = document.getElementById('home-view');
    const homeGrid = document.getElementById('home-grid');
    const playView = document.getElementById('play-view');
    const setTitle = document.getElementById('set-title');
    const quizContainer=document.getElementById('quiz');
    const progress=document.getElementById('progress');
    const finish=document.getElementById('finish');
    const finalScore=document.getElementById('final-score');
    const finalTime=document.getElementById('final-time');
    const finalMsg=document.getElementById('final-msg');
    const restartBtn=document.getElementById('restart-btn');
    const ytBtn=document.getElementById('yt-btn');
    const homeBtn=document.getElementById('home-btn');
    const homeTop=document.getElementById('home-top');
    const backTop=document.getElementById('back-top');

    // Build Next button once
    const nextBtn=document.createElement('button');
    nextBtn.id='next-btn';
    nextBtn.className='btn';
    nextBtn.textContent='Next';

    // ===== Wrong Pool (persist) =====
    const LS_KEY='eiken_wrong_v1';
    function loadWrong(){ try{ return new Set(JSON.parse(localStorage.getItem(LS_KEY)||'[]')); }catch(e){ return new Set(); } }
    function saveWrong(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(Array.from(wrongSet))); }catch(e){} }
    let wrongSet = loadWrong(); // stores BASE_QUESTIONS ids

    // ===== Audio (correct / wrong) =====
    let audioCtx;
    function getCtx(){ return audioCtx || (audioCtx = new (window.AudioContext || window.webkitAudioContext)()); }
    function beep(freq,duration=0.14,gain=0.08,type='sine'){
      const ctx=getCtx(); const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=0.0001; g.connect(ctx.destination); o.connect(g);
      o.start();
      g.gain.exponentialRampToValueAtTime(gain, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+duration);
      o.stop(ctx.currentTime+duration+0.02);
    }
    function playCorrect(){ beep(523.25,0.12); setTimeout(()=>beep(659.25,0.12),110); setTimeout(()=>beep(783.99,0.18),220); }
    function playWrong(){
      const ctx=getCtx(); const o=ctx.createOscillator(); const g=ctx.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(240,ctx.currentTime);
      o.frequency.linearRampToValueAtTime(170,ctx.currentTime+0.28);
      g.gain.setValueAtTime(0.15,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.3);
      o.connect(g); g.connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime+0.34);
    }

    // ===== TTS =====
    function speak(text){
      if(!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      const v=window.speechSynthesis.getVoices();
      const en=v.find(x=>/^en(-|_|$)/i.test(x.lang))||v[0];
      if(en) u.voice=en; u.rate=0.95; u.pitch=1;
      window.speechSynthesis.speak(u);
    }
    if ('speechSynthesis' in window) { window.speechSynthesis.getVoices(); }

    // ===== Utils =====
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
    function formatTime(ms){ const s=Math.floor(ms/1000); const m=Math.floor(s/60); const r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }

    // ===== Home Grid =====
    function buildHome(){
      homeGrid.innerHTML='';
      for(let i=1;i<=10;i++){
        const b=document.createElement('button');
        b.className='tile'; b.dataset.set=i; b.type='button';
        b.innerHTML=`<div class="title">Set ${i}</div><span class="sub">22 questions</span>`;
        b.addEventListener('click', ()=> startSet(i));
        homeGrid.appendChild(b);
      }
      const review=document.createElement('button');
      review.id='review-tile'; review.className='tile review'; review.type='button';
      review.innerHTML=`<div class="title">Review <span id="review-count" class="badge">0</span></div><span class="sub">é–“é•ãˆãŸå•é¡Œ</span>`;
      review.addEventListener('click', ()=>{ if(wrongSet.size>0) startReview(); });
      homeGrid.appendChild(review);
      updateReviewBadge();
      fitHomeGrid();
    }

    function updateReviewBadge(){
      const el=document.getElementById('review-count');
      const tile=document.getElementById('review-tile');
      if(el) el.textContent=String(wrongSet.size);
      if(tile){ wrongSet.size===0 ? tile.setAttribute('disabled','true') : tile.removeAttribute('disabled'); }
    }

    // Fit the 11 tiles into viewport without scrolling by scaling the grid down if necessary
    function fitHomeGrid(){
      const hTotal = homeView.clientHeight;
      const hdr = homeView.querySelector('.header');
      const mut = homeView.querySelector('.muted');
      const used = (hdr?hdr.offsetHeight:0) + (mut?mut.offsetHeight:0) + 16; // buffer
      const avail = Math.max(100, hTotal - used);
      const natural = homeGrid.scrollHeight;
      const scale = Math.min(1, avail / natural);
      homeGrid.style.transform = `scale(${scale})`;
    }

    function gotoHome(){
      mode='home'; currentSet=null; activeQuestions=[]; currentQuestion=0; score=0; startTime=0;
      choiceOrder=[]; answers=[]; selectedIdx=[];
      finish.style.display='none';
      playView.style.display='none';
      homeView.style.display='flex';
      updateReviewBadge();
      fitHomeGrid();
    }

    window.addEventListener('resize', fitHomeGrid);

    // ===== Play Flow =====
    function startSet(n){
      mode='set'; currentSet=n; currentQuestion=0; score=0; startTime=0;
      activeQuestions = BASE_QUESTIONS.map(q=>({...q})); // same 22 each set
      choiceOrder = Array(activeQuestions.length).fill(null);
      answers = Array(activeQuestions.length).fill(null);
      selectedIdx = Array(activeQuestions.length).fill(null);
      setTitle.textContent = `è‹±æ¤œï¼‘ç´šèªå½™å•é¡Œ â€” Set ${n}`;
      homeView.style.display='none';
      playView.style.display='flex';
      render();
    }

    function startReview(){
      if(wrongSet.size===0){ return; }
      mode='review'; currentSet='review'; currentQuestion=0; score=0; startTime=0;
      const ids=[...wrongSet];
      activeQuestions = ids.map(id=> BASE_QUESTIONS[id]).map(q=>({...q}));
      choiceOrder = Array(activeQuestions.length).fill(null);
      answers = Array(activeQuestions.length).fill(null);
      selectedIdx = Array(activeQuestions.length).fill(null);
      setTitle.textContent = `è‹±æ¤œï¼‘ç´šèªå½™å•é¡Œ â€” Review (${activeQuestions.length})`;
      homeView.style.display='none';
      playView.style.display='flex';
      render();
    }

    function ensureOrder(i){
      if(!choiceOrder[i]){
        const order=[0,1,2,3]; shuffle(order); choiceOrder[i]=order;
      }
      return choiceOrder[i];
    }

    function render(){
      if(currentQuestion===0 && !startTime){ startTime = Date.now(); }
      const q=activeQuestions[currentQuestion];
      const n=currentQuestion+1;
      if(progress) progress.textContent=`Question ${n} of ${activeQuestions.length}`;

      quizContainer.innerHTML=
        `<div class='question'><span class="qnum">(${n})</span>${q.q}</div>
         <div class='sentence-ja' id='ja-slot'></div>`;

      const order = ensureOrder(currentQuestion);
      const ul=document.createElement('ul'); ul.className='choices';
      order.forEach((origIdx,dispIdx)=>{
        const text=q.a[origIdx];
        const ja=q.jaChoices[origIdx];
        const isCorrect=(origIdx===q.correct);
        const li=document.createElement('li');
        const row=document.createElement('div'); row.className='choice-row';
        const icon=document.createElement('button'); icon.className='icon-btn'; icon.type='button'; icon.innerHTML='&#128264;';
        icon.addEventListener('click', ev => { ev.stopPropagation(); speak(text); });
        const btn=document.createElement('button'); btn.className='choice-btn'; btn.type='button'; btn.textContent=`${dispIdx+1}. ${text}`;
        btn.onclick=()=>select(btn,isCorrect,dispIdx);
        row.appendChild(icon); row.appendChild(btn); li.appendChild(row); ul.appendChild(li);
      });
      quizContainer.appendChild(ul);

      // If previously answered, restore visuals & lock
      if(answers[currentQuestion] !== null){
        const buttons = document.querySelectorAll('.choice-btn');
        const dispSel = selectedIdx[currentQuestion];
        const correctDisp = order.indexOf(q.correct);
        buttons.forEach((b,i)=>{
          b.disabled=true;
          if(!b.querySelector('.ja')){
            const jaSpan=document.createElement('span'); jaSpan.className='ja'; jaSpan.textContent = q.jaChoices[ order[i] ]; b.appendChild(jaSpan);
          }
          if(i===dispSel){ b.classList.add(answers[currentQuestion] ? 'correct' : 'wrong'); }
          if(i===correctDisp){ b.classList.add('correct'); }
        });
        const gapEl = document.querySelector('.question .gap');
        if(gapEl){ gapEl.textContent = q.a[q.correct]; gapEl.classList.remove('empty'); }
        const slot=document.getElementById('ja-slot'); slot.style.visibility='visible'; slot.textContent=q.jaSentence;
        nextBtn.style.visibility='visible';
      } else {
        nextBtn.style.visibility='hidden';
      }

      const actions=document.createElement('div'); actions.className='actions'; actions.appendChild(nextBtn); quizContainer.appendChild(actions);

      finish.style.display='none'; restartBtn.style.display='none'; ytBtn.style.display='none'; homeBtn.style.display='none';
    }

    function select(btn,ok,dispIdx){
      const q=activeQuestions[currentQuestion];
      const prev = answers[currentQuestion];
      if(prev===true){ score--; }
      answers[currentQuestion] = !!ok;
      selectedIdx[currentQuestion] = dispIdx;
      if(ok){ score++; playCorrect(); }
      else { playWrong(); }

      const order = choiceOrder[currentQuestion];
      const buttons = document.querySelectorAll('.choice-btn');
      buttons.forEach((b,i)=>{
        b.disabled=true;
        if(!b.querySelector('.ja')){ const s=document.createElement('span'); s.className='ja'; s.textContent = activeQuestions[currentQuestion].jaChoices[ order[i] ]; b.appendChild(s); }
      });
      const correctDisp = order.indexOf(q.correct);
      buttons[dispIdx].classList.add(ok ? 'correct' : 'wrong');
      if(buttons[correctDisp]) buttons[correctDisp].classList.add('correct');

      const gapEl = document.querySelector('.question .gap');
      if(gapEl){ gapEl.textContent = q.a[q.correct]; gapEl.classList.remove('empty'); }
      const slot=document.getElementById('ja-slot'); slot.style.visibility='visible'; slot.textContent=q.jaSentence;

      const qid = q.id;
      if(!ok && typeof qid==='number'){ wrongSet.add(qid); saveWrong(); updateReviewBadge(); }
      if(ok && mode==='review' && typeof qid==='number' && wrongSet.has(qid)) { wrongSet.delete(qid); saveWrong(); updateReviewBadge(); }

      nextBtn.style.visibility='visible';
    }

    nextBtn.addEventListener('click',()=>{
      currentQuestion++;
      if(currentQuestion<activeQuestions.length){
        render();
      } else {
        quizContainer.innerHTML='';
        if(progress) progress.textContent='Finished';
        finalScore.textContent=`You scored ${score} out of ${activeQuestions.length}!`;
        finalTime.textContent=`Time: ${formatTime(Date.now()-startTime)}`;

        if(score === activeQuestions.length){
          finalMsg.innerHTML = `ğŸ† Perfect! ã™ã°ã‚‰ã—ã„ï¼<br>å…¨å•æ­£è§£ã§ã—ãŸã€‚å®Ÿæˆ¦ã§ã‚‚ãã®èª¿å­ã§ï¼`;
        }else{
          finalMsg.textContent = 'Thanks for playing, and please subscribe to my YouTube channel for future updates!';
        }

        finish.style.display='flex';
        ytBtn.style.display='inline-block';
        restartBtn.style.display='inline-block';
        homeBtn.style.display='inline-block';
        nextBtn.style.visibility='hidden';
      }
    });

    restartBtn.addEventListener('click',()=>{
      // Full reset so answers/order are brand new
      currentQuestion=0; score=0; startTime=0; finish.style.display='none';
      choiceOrder = Array(activeQuestions.length).fill(null);
      answers = Array(activeQuestions.length).fill(null);
      selectedIdx = Array(activeQuestions.length).fill(null);
      render();
    });
    homeBtn.addEventListener('click',()=>{ gotoHome(); });

    homeTop.addEventListener('click',()=>{ gotoHome(); });
    backTop.addEventListener('click',()=>{
      if(mode==='home') return;
      if(currentQuestion>0){ currentQuestion--; render(); }
    });

    // ===== Boot =====
    function buildVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
    window.addEventListener('resize', buildVH); window.addEventListener('orientationchange', buildVH); buildVH();

    buildHome();
    gotoHome();
  </script>
</body>
</html>
